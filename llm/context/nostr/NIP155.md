# NIP-155

iOS Signer Application
`draft` `optional`

This NIP defines a method for **2-way communication between an iOS signer** and any Nostr client on iOS (native apps and web apps on Safari). It mirrors the goals and method surface of **NIP-55 (Android Signer)** while adapting to iOS primitives: **custom URL schemes**, **x-callback-url style callbacks**, and (optionally) **Universal Links** and **pasteboard** for large payloads.

---

## 1. Goals & Non-Goals

**Goals**

- Allow any Nostr client to request operations from a dedicated signer app that holds keys.
- Support foreground, user-approved flows with result delivery back to the caller.
- Provide a stable, minimal method surface equivalent to NIP-55:
  - `get_public_key`
  - `sign_event`
  - `nip04_encrypt`, `nip04_decrypt`
  - `nip44_encrypt`, `nip44_decrypt`
  - `decrypt_zap_event`

- Work for both **native iOS apps** and **web apps** (Safari).

**Non-Goals**

- Background/silent inter-app calls without user surface (not possible on iOS between third-party apps).
- Transport/session protocols (handled by other NIPs like NIP-46).

---

## 2. Terminology

- **Client**: iOS native app or Safari page initiating a request.
- **Signer**: iOS app that stores keys and performs crypto on user approval.
- **Custom URL Scheme**: iOS mechanism to invoke apps (e.g., `nostrsigner://`).
- **Callback**: URL that the signer opens to return results. Can be an **app scheme** (e.g., `myapp://…`) or **https** URL (for Safari/web).
- **X-Callback-URL**: De-facto convention for inter-app callbacks using `x-success`, `x-error`, `x-cancel`.

---

## 3. Transport Overview

### 3.1 Invocation

- Clients invoke the signer using a **custom URL scheme**.
- The request includes:
  - **method** (one of the methods below)
  - **params** (method-specific)
  - **callback** via either:
    - `x-success` (required): URL to call on success
    - `x-error` (optional): URL to call on error
    - `x-cancel` (optional): URL to call on user cancel

- The signer **must** open `x-success`/`x-error`/`x-cancel` to return control.

### 3.2 Result Delivery

- Results are encoded as **query parameters** on the callback URL.
- If results exceed safe URL sizes, signer **SHOULD**:
  - Prefer **HTTPS callback** and **POST redirect** (via an intermediate landing) **or**
  - Provide `compressionType=gzip` (Base64) **or**
  - Use **pasteboard** with a `pb=` token (see §8. Large Payloads).

### 3.3 Scheme Selection

- The generic scheme **`nostrsigner://`** is **RECOMMENDED** for ecosystem compatibility.
- To avoid conflicts (multiple signers installed), signers **SHOULD ALSO** expose an **app-specific scheme** (e.g., `acme-signer://`).
- Clients **SHOULD** allow the user to choose a specific signer/scheme when more than one is available.

---

## 4. iOS App Integration

### 4.1 Client App (Caller)

**Info.plist**

- Add the signer scheme(s) to **LSApplicationQueriesSchemes** to allow `canOpenURL` checks.
- Register your own **URL scheme** (e.g., `myapp://`) to receive callbacks.

**Runtime**

- Detect signer availability: `UIApplication.shared.canOpenURL(URL(string:"nostrsigner://")!)`.
- Construct request URL (see §6 Methods).
- Open the URL.

### 4.2 Signer App (Callee)

**Info.plist**

- Register `nostrsigner` and/or app-specific scheme.
- Handle `application(_:open:options:)` to parse incoming requests.

**UI/Permissions**

- Prompt user with clear origin info (see `x-source`, `client_name`, or callback host) and requested permissions.
- Support “remember my choice” per client + permission (optional, signer-local).

---

## 5. Web (Safari) Integration

- A web client triggers `nostrsigner://…` from a **user gesture**.
- **REQUIRED:** Provide an **HTTPS** `x-success` callback (e.g., `https://example.com/nostr/callback`).
- The signer returns control by opening the HTTPS callback with result parameters (and may compress).
- Web apps handle the result by parsing the query string or by serving a dedicated landing that posts the result to the SPA.

> Alternative: a Safari Web Extension that implements NIP-07 is out of scope of this NIP but can co-exist.

---

## 6. Methods

All requests use **`nostrsigner://`** with **x-callback-url** parameters.
Common parameters across methods:

| Param             | Type                                                  | Required | Description                                |
| ----------------- | ----------------------------------------------------- | -------: | ------------------------------------------ |
| `type`            | string                                                |        ✓ | One of the method names below              |
| `x-success`       | URL                                                   |        ✓ | Callback on success (app scheme or HTTPS)  |
| `x-error`         | URL                                                   |          | Callback on error                          |
| `x-cancel`        | URL                                                   |          | Callback on user cancel                    |
| `id`              | string                                                |          | Correlator returned verbatim               |
| `current_user`    | hex pubkey                                            |          | Pubkey of current logged-in user in client |
| `returnType`      | `signature` \| `event` \| `ciphertext` \| `plaintext` |          | Shape of `result`                          |
| `compressionType` | `none` \| `gzip`                                      |          | Optional compression (Base64 if gzip)      |
| `x-source`        | string                                                |          | Human-readable client name                 |
| `client_url`      | URL                                                   |          | Client homepage/identifier                 |

**Signer MUST** include `id` in callbacks if provided by client.

### 6.1 `get_public_key`

**Request**

```
nostrsigner://get_public_key
  ?type=get_public_key
  &x-success=<callback>
  [&x-error=<callback>]
  [&x-cancel=<callback>]
  [&permissions=<json>]
  [&returnType=signature]
  [&compressionType=none]
  [&x-source=AppName]
```

- `permissions` (optional JSON): default long-lived grants client is requesting (e.g., `[{ "type":"sign_event", "kind":22242 }, { "type": "nip44_decrypt" }]`).

**Success Callback Params**

- `pubkey` (hex, required)
- `package` (signer bundle id or identifier, recommended)
- `granted_permissions` (json, optional, subset of requested)

### 6.2 `sign_event`

**Request**

```
nostrsigner://sign_event
  ?type=sign_event
  &event=<url-encoded-json>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=signature|event
  &x-success=<callback>
  [&x-error=<callback>]
  [&x-cancel=<callback>]
  [&compressionType=none|gzip]
```

**Success Callback Params**

- `result` (string): signature if `returnType=signature`; otherwise ignored
- `event` (json/string): signed event if `returnType=event`
- `id` (string): echo

### 6.3 `nip04_encrypt`

**Request**

```
nostrsigner://nip04_encrypt
  ?type=nip04_encrypt
  &plaintext=<string>
  &pubkey=<hex_pubkey>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=ciphertext
  &x-success=<callback>
  [&x-error=<callback>]
  [&compressionType=none|gzip]
```

**Success**

- `result` (string): ciphertext
- `id` (string)

### 6.4 `nip04_decrypt`

**Request**

```
nostrsigner://nip04_decrypt
  ?type=nip04_decrypt
  &encryptedText=<string>
  &pubkey=<hex_pubkey>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=plaintext
  &x-success=<callback>
  [&x-error=<callback>]
  [&compressionType=none|gzip]
```

**Success**

- `result` (string): plaintext
- `id` (string)

### 6.5 `nip44_encrypt`

**Request**

```
nostrsigner://nip44_encrypt
  ?type=nip44_encrypt
  &plaintext=<string>
  &pubkey=<hex_pubkey>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=ciphertext
  &x-success=<callback>
  [&x-error=<callback>]
  [&compressionType=none|gzip]
```

**Success**

- `result` (string): ciphertext
- `id` (string)

### 6.6 `nip44_decrypt`

**Request**

```
nostrsigner://nip44_decrypt
  ?type=nip44_decrypt
  &encryptedText=<string>
  &pubkey=<hex_pubkey>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=plaintext
  &x-success=<callback>
  [&x-error=<callback>]
  [&compressionType=none|gzip]
```

**Success**

- `result` (string): plaintext
- `id` (string)

### 6.7 `decrypt_zap_event`

**Request**

```
nostrsigner://decrypt_zap_event
  ?type=decrypt_zap_event
  &event=<url-encoded-json>
  &current_user=<hex_pubkey>
  &id=<string>
  &returnType=event
  &x-success=<callback>
  [&x-error=<callback>]
  [&compressionType=none|gzip]
```

**Success**

- `result` (json/string): decrypted zap event
- `id` (string)

---

## 7. Error Semantics

On error, signer **MUST** call `x-error` (if provided) with:

| Param    | Description                     |
| -------- | ------------------------------- |
| `code`   | A stable error code (see below) |
| `reason` | Human-readable message          |
| `id`     | Echo if provided in request     |

**Standard Error Codes**

- `user_cancelled`
- `permission_denied`
- `invalid_request` (malformed/missing params)
- `unsupported_method`
- `payload_too_large`
- `not_logged_in` (no active key)
- `rate_limited`
- `internal_error`

If `x-error` is missing, signer **SHOULD** open `x-cancel` on user cancel; otherwise no callback is permitted.

---

## 8. Large Payloads

To avoid iOS URL length issues:

1. **Compression**
   - `compressionType=gzip` means the associated payload/result is **Base64-encoded gzip**.
   - Applies to `event`, `plaintext`, `encryptedText`, `result`.

2. **Pasteboard (Optional)**
   - Client may include `pb=<token>` and place the request payload in a named pasteboard item.
   - Signer reads from pasteboard; on success, writes result under the same `pb` token and calls the callback **without** large query params (e.g., `result_ref=pb:<token>`).
   - Use with clear user messaging (iOS may show paste notifications).

3. **HTTPS Callback POST (Optional)**
   - If `x-success` is HTTPS, signer may open a lightweight landing page that immediately **POSTs** the large result to the same origin and then redirects to a compact success page.

---

## 9. Permissions Model (Signer-Local)

- Signer **MAY** maintain per-client permission grants:
  - Example scope keys:
    - `sign_event` (optionally restricted by `kind`, `content_constraints`)
    - `nip04_encrypt`, `nip04_decrypt`
    - `nip44_encrypt`, `nip44_decrypt`
    - `decrypt_zap_event`

- The `permissions` hint in `get_public_key` is a **request**; signer chooses what to grant.
- Signer **SHOULD** show clear UI of who (client) is asking and what is granted.
- Signer **MAY** include a `granted_permissions` JSON in `get_public_key` success.

---

## 10. Caller Identification

To help users recognize the requester, clients **SHOULD** include:

- `x-source`: a human-readable name
- `client_url`: a canonical URL
- For app callbacks, the signer **SHOULD** also capture and display the **callback scheme host**.

---

## 11. Security Considerations

- **Key Storage**: Use iOS Keychain / Secure Enclave when possible; offer biometric gate on sensitive ops.
- **Phishing**: Display `x-source` / `client_url` prominently. Optionally verify callback domain consistency.
- **Replay**: Signer **SHOULD** bind approvals to an `id` and show event details to user before signing.
- **Rate limiting**: Prevent rapid-fire signing without user visibility (even with stored grants).
- **Integrity**: For `sign_event`, signer **MUST** show or validate the canonicalized event fields that will be signed.

---

## 12. UX Guidance

- Minimize taps: remember grants where appropriate; still surface **which** event you’re signing.
- Show the **account / pubkey** being used.
- On cancel or error, return quickly via `x-cancel`/`x-error` for predictable client behavior.

---

## 13. Versioning & Discovery

- **Version param**: Signers **MAY** accept `v=1` to signal method surface; future expansion can bump this.
- **Discovery**: Clients can probe availability via `canOpenURL("nostrsigner://get_public_key?type=get_public_key")`.
  If multiple signers are available, present a chooser UX and persist user preference.

---

## 14. Example Flows

### 14.1 Native App: `sign_event` (return signature)

**Client builds:**

```
nostrsigner://sign_event
 ?type=sign_event
 &event=%7B%22kind%22%3A1%2C%22content%22%3A%22hello%22%7D
 &current_user=ABCDEF...
 &id=42
 &returnType=signature
 &x-success=myapp://nostr/signed
 &x-error=myapp://nostr/error
 &x-source=MyNostrClient
```

**Signer returns:**

```
myapp://nostr/signed?id=42&result=<hex_signature>
```

### 14.2 Web (Safari): `get_public_key`

**Web page opens:**

```
nostrsigner://get_public_key
 ?type=get_public_key
 &x-success=https://example.com/nostr/callback
 &x-error=https://example.com/nostr/callback-error
 &permissions=%5B%7B%22type%22%3A%22sign_event%22%7D%5D
 &x-source=ExampleWeb
```

**Signer returns:**

```
https://example.com/nostr/callback?pubkey=<hex>&package=<bundle_id>
```

---

## 15. Backwards & Interop Notes

- This NIP mirrors NIP-55’s method set and parameter spirit while replacing Android-specific **intents/content resolvers** with iOS **URL schemes + callbacks**.
- Signers that also implement **NIP-46** can coexist; a client may select local signer (NIP-155) or remote signer (NIP-46) per context.

---

## 16. Compliance Matrix (MUST/SHOULD)

**Signer MUST**

- Accept method `type` and return via `x-success`/`x-error` appropriately.
- Echo `id` if provided.
- Protect keys using iOS security primitives.
- Present clear user prompts naming the caller.

**Client MUST**

- Provide `x-success` (app scheme or HTTPS).
- URL-encode JSON/body parameters.
- Handle errors and cancels predictably.

**Signer SHOULD**

- Support `returnType` and `compressionType`.
- Support app-specific scheme in addition to `nostrsigner`.
- Provide consistent error codes.

**Client SHOULD**

- Let users choose a signer if multiple are installed.
- Prefer HTTPS callbacks for large results (or support pasteboard tokens).

---

## 17. Registry (Proposed)

- **Method names**: `get_public_key`, `sign_event`, `nip04_encrypt`, `nip04_decrypt`, `nip44_encrypt`, `nip44_decrypt`, `decrypt_zap_event`
- **Common params**: `id`, `x-success`, `x-error`, `x-cancel`, `compressionType`, `returnType`, `current_user`, `x-source`, `client_url`
- **Error codes**: `user_cancelled`, `permission_denied`, `invalid_request`, `unsupported_method`, `payload_too_large`, `not_logged_in`, `rate_limited`, `internal_error`

---

### Appendix A — Minimal Swift Pseudocode (Client)

```swift
// Build URL
var comps = URLComponents(string: "nostrsigner://sign_event")!
comps.queryItems = [
  .init(name: "type", value: "sign_event"),
  .init(name: "event", value: encodedEventJSON),
  .init(name: "current_user", value: userPubkey),
  .init(name: "id", value: "42"),
  .init(name: "returnType", value: "signature"),
  .init(name: "x-success", value: "myapp://nostr/signed"),
  .init(name: "x-error", value: "myapp://nostr/error"),
  .init(name: "x-source", value: "MyNostrClient")
]
if let url = comps.url, UIApplication.shared.canOpenURL(url) {
  UIApplication.shared.open(url)
}
```

---

**End of NIP-155 (iOS Signer Application)**

---

## Appendix B — Minimal Expo (React Native) Signer Using SNSTR

This app implements a tiny signer that handles two methods: `get_public_key` and `sign_event`.

- Deep-link handler: see `app/_layout.tsx` — listens for `nostrsigner://` and `nip55-ios-test://` and routes to `/sign` with the raw URL.
- Request parsing + callbacks: `lib/nip155.ts` — parses the request, builds success/error callback URLs, and opens them.
- Approval UI: `app/sign.tsx` — displays the request and performs the action using SNSTR.
- Callback UX: `app/debug/success.tsx` and `app/debug/error.tsx` display decoded results when running in environments (Expo Go) that cannot open custom schemes directly.

Install note: the app registers scheme `nip55-ios-test`. For generic interop, clients should prefer `nostrsigner://`, but during development you can target this app directly with `nip55-ios-test://`.

Example (client → signer):

```
// Build a sign_event request (URL-encoded JSON payload)
const event = encodeURIComponent(JSON.stringify({ kind: 1, content: 'hello', tags: [] }));
const url = `nip55-ios-test://sign_event?type=sign_event&event=${event}`
  + `&returnType=signature&x-success=myapp://ok&x-error=myapp://err&id=42`;
Linking.openURL(url);
```

On approval, the signer calls:

```
myapp://ok?id=42&result=<hex_signature>
```

Security notes:

- The demo rejects `compressionType=gzip` to avoid bundling compression libs in the minimal app.
- If `current_user` is supplied and does not match the stored signer, the request is rejected with `permission_denied`.
- For production, implement the remaining methods and consider pasteboard/universal-link fallbacks for large payloads.
- To avoid trusting caller-supplied data, the implementation ignores any `pubkey` field embedded in a `sign_event` payload and re-derives the public key from the on-device private key before hashing/signing. The draft spec should explicitly allow—or even recommend—that signers override the `pubkey` field instead of using the caller-provided value.
- During development we simulate callbacks by re-routing `x-success`/`x-error` inside the app when the OS cannot launch custom schemes. A short note in the draft could call out that signers MAY provide such debug fallbacks without violating the protocol.
